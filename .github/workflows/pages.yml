name: GitHub Pages

on:
  push:
    branches: [ "master" ]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ALLOW_EMPTY_PASSWORD: yes
          MYSQL_DATABASE: symfony_test
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - uses: actions/checkout@v4

      - uses: shivammathur/setup-php@v2
        with:
          php-version: '8.5'
          extensions: pdo_mysql, xdebug
          coverage: xdebug
          tools: composer:v2

      - name: Install Dependencies
        run: composer install --no-ansi --no-interaction --prefer-dist

      - name: Setup Database
        env:
          DATABASE_URL: mysql://root:@127.0.0.1:3306/symfony
        run: |
          bin/console doctrine:database:create --env=test --if-not-exists
          bin/console doctrine:migrations:migrate -n --env=test
          bin/console doctrine:fixtures:load -n --env=test

      - name: Run Tests with Coverage
        env:
          DATABASE_URL: mysql://root:@127.0.0.1:3306/symfony
          XDEBUG_MODE: coverage
        run: vendor/bin/phpunit --coverage-html coverage

      - name: Assemble Site
        run: |
          mkdir _site
          mv coverage _site/coverage
          cat > _site/index.html <<'HEREDOC'
          <!DOCTYPE html>
          <html lang="en">
          <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>MiniCC KuKu</title>
          <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
          </head>
          <body>
          <div class="container py-5">
          <div class="row justify-content-center">
          <div class="col-lg-8">
          <h1 class="mb-3">MiniCC KuKu</h1>
          <p class="lead text-secondary">Financial management application for handling credit cards, deposits, transactions, and store management.</p>
          <hr>
          <h5>Tech Stack</h5>
          <ul>
          <li>PHP 8.4+ with Symfony 8.x</li>
          <li>Doctrine ORM with PostgreSQL</li>
          <li>Twig 3.x with Bootstrap 5.3</li>
          <li>Stimulus.js</li>
          </ul>
          <hr>
          <h5>Reports</h5>
          <ul>
          <li><a href="coverage/">Code Coverage Report</a></li>
          </ul>
          <hr>
          <p><a href="https://github.com/elkuku/minicc-kuku" class="btn btn-outline-dark btn-sm">View on GitHub</a></p>
          <p class="text-muted small">Last updated: TIMESTAMP_PLACEHOLDER</p>
          </div>
          </div>
          </div>
          </body>
          </html>
          HEREDOC
          sed -i "s/TIMESTAMP_PLACEHOLDER/$(date -u '+%Y-%m-%d %H:%M:%S UTC')/" _site/index.html

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
